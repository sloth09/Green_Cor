# Development History and Architecture Notes

## v2.4: Annualized CAPEX Methodology (2025-11-22)

### Problem
Previous NPC calculation used actual CAPEX spending by year, which:
- Ignored salvage value of assets purchased late in project (e.g., 2045 shuttle had 15 years remaining life in 2050)
- Made scenarios with different purchase timing incomparable
- Underestimated true project cost for scenarios with staggered asset acquisition

**Example Issue:**
- Shuttle purchased in 2030: Used for 21 years (2030-2050) → Full value consumed
- Shuttle purchased in 2045: Used for 6 years (2045-2050) → 15 years of remaining life ignored
- Old method: Both counted as same $20M cost
- Correct method: 2045 shuttle should reflect its remaining value beyond 2050

### Solution
Switched to **Annualized CAPEX methodology** (consistent with `yearly_simulation` mode):
- **Annual Cost = Annualized_CAPEX + OPEX**
- **Annualized_CAPEX = Total_Asset_Value / Annuity_Factor**
- Automatically accounts for asset lifetime and salvage value
- Ensures fair comparison across all scenarios regardless of purchase timing

### Implementation Details

#### Modified Files:
1. **`src/optimizer.py`** (Lines 360-420, 475-665):
   - Changed NPC accumulation from actual CAPEX to Annualized CAPEX
   - For each year: Calculate total asset value (N_val × unit_capex) → Convert to annualized cost
   - Updated scenario results column names for clarity (`NPC_Annualized_Shuttle_CAPEX_USDm`, etc.)
   - Updated yearly results to include both actual and annualized CAPEX columns
   - `Total_Year_Cost` now uses Annualized_CAPEX + OPEX

2. **`main.py`** (Lines 789-799):
   - Updated `run_yearly_simulation()` to use Annualized CAPEX in `Total_Year_Cost` calculation
   - Added `Total_OPEX_USDm` column for clarity
   - Ensured consistency with optimizer methodology

3. **`tests/test_annualized_capex_consistency.py`** (New file):
   - Automated test to verify Single mode NPC_Total equals Yearly Simulation 21-year sum
   - Validates consistency between optimization and simulation modes
   - Tolerance: 0.25% (accounts for minor rounding differences)

### Verification Results
- **Test Case**: Case 1, Shuttle 5000m³, Pump 500m³/h
- **Yearly Simulation 21-year sum**: $249.67M
- **Single Mode NPC_Total**: $249.67M
- **Difference**: $0.005M (0.002%) ✅

### Impact
- **Scenarios with early purchases (2030-2035)**: Minimal NPC change (~0-2%)
- **Scenarios with late purchases (2045-2050)**: Higher NPC (more accurate, reflects salvage value)
- **All scenarios**: Now directly comparable on equal footing
- **Methodology**: Consistent with standard infrastructure cost analysis practices

### Key Formulas

**Old Method (Incorrect):**
```
NPC_Total = Σ(Actual_CAPEX[year] + OPEX[year])
          = Σ(unit_capex × new_assets[year] + OPEX[year])
```

**New Method (Correct):**
```
NPC_Total = Σ(Annualized_CAPEX[year] + OPEX[year])

Where:
Annualized_CAPEX[year] = Total_Asset_Value[year] / Annuity_Factor
Total_Asset_Value[year] = Total_Owned_Assets[year] × unit_capex
Annuity_Factor = (1 - (1 + r)^-n) / r  (where r = 7%, n = 21 years)
```

### Technical Notes
- The `Annuity_Factor` (default: 10.594 for 7% over 21 years) converts a lump sum into equivalent annual payments
- `calculate_annualized_capex_yearly()` in `CostCalculator` performs this conversion
- Yearly results now include both `Actual_CAPEX_*` (reference) and `Annualized_CAPEX_*` (used in total cost)
- This methodology is standard in infrastructure project economics (e.g., LCOE calculations)

### Breaking Changes
- **NPC values will change** for all scenarios (especially those with late asset purchases)
- **Column names updated** in scenario results: `NPC_Shuttle_CAPEX_USDm` → `NPC_Annualized_Shuttle_CAPEX_USDm`
- **Yearly results structure changed**: Added `Actual_CAPEX_*` and `Total_OPEX_USDm` columns
- Old results files are not directly comparable to new results

---
